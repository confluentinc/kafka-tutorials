agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1
global_job_config:
  secrets:
    - name: vault_sem2_approle
  prologue:
    commands:
      - echo $SEMAPHORE_WORKFLOW_ID
      - sudo add-apt-repository ppa:cwchien/gradle -y
      - checkout
      - make install-vault
      - . vault-bin/vault-setup
      - . vault-sem-get-secret aws_credentials
      - . vault-sem-get-secret dockerhub-semaphore-cred
      - . vault-sem-get-secret artifactory-docker-helm
      - >
        aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin "$(aws sts get-caller-identity | jq -r .Account).dkr.ecr.us-west-2.amazonaws.com"
      - docker login --username $DOCKERHUB_USER --password $DOCKERHUB_APIKEY
      - docker login --username $DOCKER_USER --password $DOCKER_APIKEY confluent-docker.jfrog.io
      - sem-version python 3.8
      - pip3 install -e harness_runner/
      - >
        find _includes/tutorials/**/ksql -name docker-compose.yml | xargs -I {} sed -i -E "s/(\s+)(KSQL_CONFIG_DIR.*)/\1\2\\n\1KSQL_CONFLUENT_SUPPORT_METRICS_ENABLE: \"false\"/g" {}
blocks:
- execution_time_limit:
    minutes: 10
  name: Run the tests part 1
  task:
    jobs:
    - commands:
      - make -C _includes/tutorials/transforming/ksql/code tutorial
      name: KSQL transforming tests
    - commands:
      - make -C _includes/tutorials/filtering/ksql/code tutorial
      name: KSQL filtering tests
    - commands:
      - make -C _includes/tutorials/splitting/ksql/code tutorial
      name: KSQL splitting tests
    - commands:
      - make -C _includes/tutorials/merging/ksql/code tutorial
      name: KSQL merging tests
    - commands:
      - make -C _includes/tutorials/joining-stream-stream/ksql/code tutorial
      name: KSQL join stream to stream tests
    - commands:
      - make -C _includes/tutorials/joining-stream-table/ksql/code tutorial
      name: KSQL join stream to table tests
    - commands:
      - make -C _includes/tutorials/joining-table-table/ksql/code tutorial
      name: KSQL join table to table tests
    - commands:
      - make -C _includes/tutorials/tumbling-windows/ksql/code tutorial
      name: KSQL tumbling windows tests
    - commands:
      - make -C _includes/tutorials/session-windows/ksql/code tutorial
      name: KSQL session windows tests
    - commands:
      - make -C _includes/tutorials/aggregating-count/ksql/code tutorial
      name: KSQL aggregation count tests
    - commands:
      - make -C _includes/tutorials/aggregating-minmax/ksql/code tutorial
      name: KSQL aggregation MIN/MAX tests

- execution_time_limit:
    minutes: 10
  name: Run the tests part 2
  task:
    jobs:
    - commands:
      - make -C _includes/tutorials/aggregating-sum/ksql/code tutorial
      name: KSQL aggregation sum tests
    - commands:
      - make -C _includes/tutorials/serialization/ksql/code tutorial
      name: KSQL serialization tests
    - commands:
      - make -C _includes/tutorials/rekeying/ksql/code tutorial
      name: KSQL rekey stream tests
    - commands:
      - make -C _includes/tutorials/rekeying-function/ksql/code tutorial
      name: KSQL rekey stream with function tests
    - commands:
      - make -C _includes/tutorials/connect-add-key-to-source/ksql/code tutorial
      name: ksqlDB  Connect SMT key tests
    - commands:
      - make -C _includes/tutorials/udf/ksql/code tutorial
      name: KSQL UDF tests
    - commands:
      - make -C _includes/tutorials/hopping-windows/ksql/code tutorial
      name: KSQL hopping windows tests
    - commands:
      - make -C _includes/tutorials/finding-distinct/ksql/code tutorial
      name: KSQL finding distinct events tests
    - commands:
      - make -C _includes/tutorials/flatten-nested-data/ksql/code tutorial
      name: KSQL flatten nested data
    - commands:
      - make -C _includes/tutorials/deserialization-errors/ksql/code tutorial
      name: KSQL deserialization errors tests
name: Kafka Tutorials pipeline
version: v1.0

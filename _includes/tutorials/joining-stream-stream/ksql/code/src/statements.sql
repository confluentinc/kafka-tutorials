CREATE STREAM ORDERS (ORDER_ID INT, ORDER_TS VARCHAR, TOTAL_AMOUNT DOUBLE, CUSTOMER_NAME VARCHAR)
              WITH (KAFKA_TOPIC='_orders',
                    VALUE_FORMAT='JSON',
                    TIMESTAMP='ORDER_TS',
                    TIMESTAMP_FORMAT='yyyy-MM-dd''T''HH:mm:ssX',
                    PARTITIONS=4,
                    REPLICAS=1);

CREATE STREAM SHIPMENTS (SHIPMENT_ID VARCHAR, SHIP_TS VARCHAR, ORDER_ID INT, WAREHOUSE VARCHAR)
              WITH (KAFKA_TOPIC='_shipments',
                    VALUE_FORMAT='JSON',
                    TIMESTAMP='SHIP_TS',
                    TIMESTAMP_FORMAT='yyyy-MM-dd''T''HH:mm:ssX',
                    PARTITIONS=4,
                    REPLICAS=1);

CREATE STREAM ORDERS_SHIPMENTS AS
    SELECT
        O.ORDER_ID AS ORDER_ID, TIMESTAMPTOSTRING(O.ROWTIME,'yyyy-MM-dd HH:mm:ss') AS ORDER_TS,
        O.TOTAL_AMOUNT, O.CUSTOMER_NAME, S.SHIPMENT_ID, TIMESTAMPTOSTRING(S.ROWTIME,'yyyy-MM-dd HH:mm:ss') AS SHIPMENT_TS,
        S.WAREHOUSE, (S.ROWTIME - O.ROWTIME)/1000/60 AS SHIP_TIME
    FROM ORDERS O INNER JOIN SHIPMENTS S
    WITHIN 7 DAYS
    ON O.ORDER_ID = S.ORDER_ID;
